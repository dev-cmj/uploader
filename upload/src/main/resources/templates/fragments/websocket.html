<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:fragment="websocket-resources">
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4-next/lib/stomp.min.js"></script>
    </th:block>
</head>
<body>
<th:block th:fragment="websocket-client">
    <script th:inline="javascript">
        // 웹소켓 클라이언트 공통 기능
        const WebSocketClient = {
            stompClient: null,

            // 웹소켓 연결
            connect: function(id, statusCallback) {
                const socket = new SockJS('/ws');
                this.stompClient = Stomp.over(socket);

                this.stompClient.connect({}, function() {
                    console.log('웹소켓 연결 성공했습니다.');

                    // 특정 콘텐츠 ID에 대한 상태 업데이트 구독
                    if (id) {
                        WebSocketClient.stompClient.subscribe('/queue/status/' + id, function(message) {
                            const statusUpdate = JSON.parse(message.body);
                            if (statusCallback) {
                                statusCallback(statusUpdate);
                            }
                        });
                    }
                }, function(error) {
                    console.error('웹소켓 연결 실패:', error);
                });
            },

            // 웹소켓 연결 해제
            disconnect: function() {
                if (this.stompClient !== null) {
                    this.stompClient.disconnect();
                    console.log('웹소켓 연결 해제');
                }
            },

            // 메시지 발행
            send: function(destination, message) {
                if (this.stompClient && this.stompClient.connected) {
                    this.stompClient.send(destination, {}, JSON.stringify(message));
                } else {
                    console.error('웹소켓이 연결되어 있지 않습니다.');
                }
            }
        };
    </script>
</th:block>
</body>
</html>